<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟货架可视化</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 基本布局 */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 自定义动画效果 */
        .shelf-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            padding: 2rem;
        }

        .bin-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .bin-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        /* 选中态 */
        .bin-selected {
            border: 2px solid #3B82F6 !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.1);
            z-index: 10;
        }

        /* 搜索高亮脉冲动画 */
        @keyframes pulse-highlight {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(234, 179, 8, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
            }
        }

        .search-match {
            animation: pulse-highlight 1.5s infinite;
            border-color: #EAB308 !important;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3B82F6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Animation */
        .toast-enter-active,
        .toast-leave-active {
            transition: all 0.3s ease;
        }

        /* Outbound Modal */
        .modal-enter-active,
        .modal-leave-active {
            transition: opacity 0.3s ease;
        }

        .modal-enter-from,
        .modal-leave-to {
            opacity: 0;
        }

        /* Blinking border for move mode */
        @keyframes blink-border {

            0%,
            100% {
                border-color: rgba(59, 130, 246, 0.5);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }

            50% {
                border-color: rgba(59, 130, 246, 1);
                box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            }
        }

        .move-mode-active {
            animation: blink-border 1.5s infinite;
        }
    </style>
</head>

<body class="bg-gray-900 text-slate-200 font-sans overflow-hidden h-screen flex flex-col">

    <div id="app" class="h-full flex flex-col">

        <!-- Global Loading Overlay -->
        <div v-if="isLoading" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <div class="text-blue-400 font-bold tracking-wider animate-pulse">系统资源加载中...</div>
            <div class="text-slate-500 text-xs mt-2 font-mono">Connecting to Warehouse Visualization Engine</div>
        </div>

        <!-- Inbound Modal -->
        <transition name="modal">
            <div v-if="showInboundModal" class="fixed inset-0 z-[60] flex items-center justify-center">
                <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="showInboundModal = false"></div>
                <div class="bg-gray-800 rounded-xl shadow-2xl border border-gray-700 p-6 w-[480px] relative z-10">
                    <h3 class="text-lg font-bold text-white mb-4">入库分配</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">物料名称</label>
                                <input type="text" v-model="inboundForm.material" placeholder="输入物料名称"
                                    class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none text-sm">
                            </div>
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">物料ID</label>
                                <input type="text" v-model="inboundForm.matId" placeholder="M-xxxx"
                                    class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none text-sm">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">数量</label>
                                <input type="number" v-model.number="inboundForm.qty" min="1"
                                    class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none text-sm">
                            </div>
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">单位</label>
                                <select v-model="inboundForm.unit"
                                    class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none text-sm">
                                    <option value="个">个</option>
                                    <option value="盒">盒</option>
                                    <option value="台">台</option>
                                    <option value="条">条</option>
                                    <option value="把">把</option>
                                    <option value="块">块</option>
                                    <option value="箱">箱</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">批次号</label>
                            <input type="text" v-model="inboundForm.batch" placeholder="B-xxxx"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none text-sm">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">图标类型</label>
                            <div class="grid grid-cols-5 gap-2">
                                <div v-for="icon in availableIcons" :key="icon" @click="inboundForm.icon = icon"
                                    :class="['cursor-pointer rounded p-2 text-center transition-colors border', inboundForm.icon === icon ? 'bg-blue-600/20 border-blue-500 text-blue-400' : 'bg-gray-900 border-gray-700 text-slate-500 hover:border-gray-500']">
                                    <i :class="['fa-solid', icon]"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button @click="showInboundModal = false"
                            class="px-4 py-2 text-slate-400 hover:text-white transition-colors">取消</button>
                        <button @click="confirmInbound"
                            class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg shadow-lg">确认入库</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Outbound Modal -->
        <transition name="modal">
            <div v-if="showOutboundModal" class="fixed inset-0 z-[60] flex items-center justify-center">
                <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" @click="showOutboundModal = false"></div>
                <div class="bg-gray-800 rounded-xl shadow-2xl border border-gray-700 p-6 w-96 relative z-10">
                    <h3 class="text-lg font-bold text-white mb-4">出库确认</h3>
                    <div class="mb-4">
                        <label class="block text-sm text-slate-400 mb-1">出库数量 (库存: {{ currentBin?.qty }})</label>
                        <input type="number" v-model.number="outboundQty" min="1" :max="currentBin?.qty"
                            class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none">
                    </div>
                    <div class="flex justify-end gap-3">
                        <button @click="showOutboundModal = false"
                            class="px-4 py-2 text-slate-400 hover:text-white transition-colors">取消</button>
                        <button @click="confirmOutbound"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg shadow-lg">确认出库</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Toast Notification -->
        <transition name="toast">
            <div v-if="toastMessage"
                class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800 border border-gray-600 text-white px-6 py-3 rounded-lg shadow-2xl z-50 flex items-center gap-3">
                <i class="fa-solid fa-circle-info text-blue-400"></i>
                <span>{{ toastMessage }}</span>
            </div>
        </transition>

        <!-- 顶部标题栏 -->
        <header
            class="h-16 flex items-center justify-between px-6 bg-gray-800 border-b border-gray-700 backdrop-blur-md shrink-0">
            <div class="flex items-center gap-4">
                <span class="iconify text-3xl text-gray-400" data-icon="mdi:warehouse"></span>
                <h1 class="text-xl font-bold tracking-widest text-white">虚拟货架</h1>
            </div>

            <div class="flex-1 max-w-md mx-8">
                <div class="relative group">
                    <span
                        class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 group-focus-within:text-blue-400 transition-colors">
                        <i class="fa-solid fa-search"></i>
                    </span>
                    <input type="text" v-model="searchKeyword" @input="handleSearch" placeholder="搜索物料 / 编码 / ID..."
                        class="w-full bg-gray-900/50 text-slate-200 border border-gray-600 rounded-lg py-1.5 pl-10 pr-4 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-600">
                    <button v-if="searchKeyword" @click="searchKeyword = ''"
                        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-white cursor-pointer">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-8">
                <div v-if="isMoveMode"
                    class="bg-blue-600/20 border border-blue-500 text-blue-300 px-4 py-1.5 rounded-full text-sm animate-pulse font-bold flex items-center gap-2">
                    <i class="fa-solid fa-arrows-up-down-left-right"></i> 请选择目标货位...
                    <button @click="cancelMove" class="hover:text-white ml-2"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="flex items-center gap-4 text-sm text-slate-400">
                    <div class="flex items-center gap-1.5"><span
                            class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        系统监控中
                    </div>
                    <div class="font-mono">{{ currentTime }}</div>
                </div>
                <div class="flex bg-gray-700 rounded-lg p-1">
                    <button
                        class="px-4 py-1.5 rounded-md text-gray-400 hover:text-white text-sm transition-colors">主页</button>
                    <button class="px-4 py-1.5 rounded-md bg-gray-600 text-white text-sm shadow-lg">虚拟货架</button>
                    <button
                        class="px-4 py-1.5 rounded-md text-gray-400 hover:text-white text-sm transition-colors">货架管理</button>
                </div>
            </div>
        </header>

        <!-- 主体内容 -->
        <div class="flex-1 flex overflow-hidden">

            <!-- 货架主视图 -->
            <div class="flex-1 flex flex-col relative h-full">

                <!-- 网格区域 -->
                <div class="flex-1 overflow-auto bg-gray-900 p-8 relative custom-scrollbar">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-slate-400 mb-4 flex items-center">
                            <span class="iconify mr-2" data-icon="mdi:map-marker-path"></span> A区 - 电子元器件库
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <div v-for="shelf in shelves" :key="shelf.id"
                                class="bg-gray-800/40 p-4 rounded-xl border border-gray-700 hover:border-gray-600 transition-all">
                                <div
                                    class="flex justify-between mb-3 text-xs text-slate-500 uppercase font-bold tracking-wider">
                                    <span>{{ shelf.code }}</span>
                                    <span>{{ shelf.type }}</span>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div v-for="bin in shelf.bins" :key="bin.id" @click="selectBin(bin)" :class="[
                                        'bin-item h-24 rounded-lg border flex flex-col items-center justify-center relative p-2 transition-all',
                                        getBinColorClass(bin, shelf),
                                        { 'bin-selected': currentBin && currentBin.id === bin.id },
                                        { 'search-match': isMatch(bin) },
                                        { 'move-mode-active': isMoveMode && !bin.material }
                                    ]">
                                        <span class="text-[10px] font-mono absolute top-1 left-1 opacity-50">{{ bin.code
                                            }}</span>

                                        <div v-if="bin.material" class="text-center w-full">
                                            <i :class="['fa-solid', bin.icon, 'text-2xl mb-2 opacity-80']"></i>
                                            <div class="text-xs font-bold truncate px-1">{{ bin.material }}</div>
                                            <div class="text-[10px] opacity-60 mt-0.5">Qty: {{ bin.qty }}</div>
                                        </div>
                                        <div v-else class="text-slate-600 flex flex-col items-center">
                                            <i class="fa-solid fa-box-open text-2xl mb-1 opacity-30"></i>
                                            <div class="text-[10px]">空闲</div>
                                        </div>

                                        <span v-if="bin.status === 'warning'"
                                            class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full shadow-lg animate-bounce">
                                            !
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部状态栏 -->
                <div
                    class="bg-gray-800 border-t border-gray-700 p-2 text-[10px] text-slate-500 flex justify-between shrink-0">
                    <span>渲染引擎: WebGL (Simulated) | 节点数: {{ totalBins }}</span>
                    <span>数据最后更新: {{ lastUpdateTime }}</span>
                </div>
            </div>

            <!-- 详情抽屉 -->
            <transition enter-active-class="transition ease-out duration-300"
                enter-from-class="transform translate-x-full" enter-to-class="transform translate-x-0"
                leave-active-class="transition ease-in duration-200" leave-from-class="transform translate-x-0"
                leave-to-class="transform translate-x-full">
                <div v-if="currentBin"
                    class="w-96 bg-gray-800 shadow-2xl border-l border-gray-700 flex flex-col z-30 shrink-0">
                    <div class="p-5 border-b border-gray-700 flex justify-between items-start bg-gray-800">
                        <div>
                            <h3 class="font-bold text-lg text-white">货位详情</h3>
                            <p class="text-sm text-slate-400 font-mono">{{ currentBin.code }}</p>
                        </div>
                        <button @click="currentBin = null" class="text-slate-400 hover:text-white transition-colors">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <div v-if="detailLoading" class="flex-1 flex flex-col items-center justify-center text-slate-500">
                        <div class="loader mb-4 w-8 h-8 border-2"></div>
                        <p class="text-sm animate-pulse">正在从数据库获取详情...</p>
                    </div>

                    <div v-else class="flex-1 overflow-y-auto p-5 custom-scrollbar">

                        <div v-if="!currentBin.material" class="text-center py-10 text-slate-500">
                            <div
                                class="bg-gray-700/50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-box-open text-4xl opacity-50"></i>
                            </div>
                            <p class="mb-4">当前货位为空</p>
                            <button @click="initiateInbound"
                                class="px-4 py-2 bg-blue-600/20 text-blue-400 border border-blue-500/30 rounded-lg text-sm hover:bg-blue-600/30 transition-colors">
                                执行入库分配
                            </button>
                        </div>

                        <div v-else>
                            <div class="bg-gray-700/30 rounded-xl p-4 mb-6 border border-gray-600/50">
                                <div class="flex items-center gap-3 mb-4">
                                    <div
                                        class="w-14 h-14 bg-gray-700 rounded-lg flex items-center justify-center shadow-inner text-blue-400 text-2xl border border-gray-600">
                                        <i :class="['fa-solid', currentBin.icon]"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-white text-lg">{{ currentBin.material }}</div>
                                        <div class="text-xs text-slate-400 font-mono">ID: {{ currentBin.matId }}</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div class="bg-gray-800/50 p-2 rounded border border-gray-700/50">
                                        <div class="text-slate-500 text-xs mb-1">库存数量</div>
                                        <div class="font-mono font-bold text-white">{{ currentBin.qty }} <span
                                                class="text-xs text-slate-400">{{ currentBin.unit }}</span></div>
                                    </div>
                                    <div class="bg-gray-800/50 p-2 rounded border border-gray-700/50">
                                        <div class="text-slate-500 text-xs mb-1">批次号</div>
                                        <div class="font-mono text-slate-300">{{ currentBin.batch }}</div>
                                    </div>
                                    <div class="bg-gray-800/50 p-2 rounded border border-gray-700/50">
                                        <div class="text-slate-500 text-xs mb-1">入库时间</div>
                                        <div class="text-slate-300">2023-10-12</div>
                                    </div>
                                    <div class="bg-gray-800/50 p-2 rounded border border-gray-700/50">
                                        <div class="text-slate-500 text-xs mb-1">状态</div>
                                        <div
                                            :class="currentBin.status === 'warning' ? 'text-red-400 font-bold' : 'text-emerald-400 font-bold'">
                                            {{ currentBin.status === 'warning' ? '库存告警' : '正常' }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h4 class="font-bold text-sm text-slate-300 mb-4 flex items-center">
                                    <i class="fa-solid fa-clock-rotate-left mr-2 text-blue-400"></i> 全生命周期追溯
                                </h4>
                                <div class="relative pl-4 border-l border-gray-600 space-y-6">
                                    <div v-for="(trace, index) in currentBin.traceability" :key="index"
                                        :class="['relative', index > 0 ? 'opacity-60' : 'group']">
                                        <span
                                            :class="['absolute -left-[21px] top-1 w-3 h-3 rounded-full border-2 border-gray-800', index === 0 ? 'bg-blue-500 shadow-[0_0_0_4px_rgba(59,130,246,0.2)]' : 'bg-gray-500']"></span>
                                        <div
                                            :class="['text-xs mb-0.5', index === 0 ? 'text-blue-400' : 'text-slate-500']">
                                            {{ trace.time }}</div>
                                        <div
                                            :class="['text-sm font-medium', index === 0 ? 'text-slate-200' : 'text-slate-300']">
                                            {{ trace.event }}</div>
                                        <div class="text-xs text-slate-500">{{ trace.detail }}</div>
                                    </div>

                                    <div v-if="!currentBin.traceability || currentBin.traceability.length === 0"
                                        class="text-xs text-slate-500 italic">
                                        暂无追溯记录
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold text-sm text-slate-300 mb-3 flex items-center">
                                    <i class="fa-solid fa-video mr-2 text-blue-400"></i> 实时监控/回放
                                </h4>
                                <div
                                    class="bg-black rounded-lg h-32 flex items-center justify-center text-slate-500 relative overflow-hidden group cursor-pointer border border-gray-700 hover:border-blue-500/50 transition-colors">
                                    <img src="https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
                                        class="absolute inset-0 w-full h-full object-cover opacity-30 group-hover:opacity-50 transition-opacity">
                                    <div class="z-10 flex flex-col items-center">
                                        <i
                                            class="fa-solid fa-play-circle text-3xl text-white mb-1 group-hover:scale-110 transition-transform"></i>
                                        <span class="text-xs text-white">点击播放回放</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-gray-700 bg-gray-800 grid grid-cols-2 gap-3"
                        v-if="!detailLoading && currentBin.material">
                        <button @click="initiateMove"
                            class="py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm transition-colors border border-gray-600">移库操作</button>
                        <button @click="initiateOutbound"
                            class="py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm shadow-lg shadow-blue-600/20 transition-colors">出库下架</button>
                    </div>
                </div>
            </transition>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentTime: '',
                    searchKeyword: '',
                    currentBin: null,
                    lastUpdateTime: new Date().toLocaleTimeString(),
                    isLoading: true, // 全局加载状态
                    detailLoading: false, // 详情加载状态
                    toastMessage: null, // 消息提示

                    // Outbound & Move States
                    showOutboundModal: false,
                    outboundQty: 1,
                    isMoveMode: false,
                    moveSourceBin: null,

                    // Inbound States
                    showInboundModal: false,
                    inboundForm: {
                        material: '',
                        matId: '',
                        qty: 1,
                        unit: '个',
                        batch: '',
                        icon: 'fa-box'
                    },
                    availableIcons: [
                        'fa-box', 'fa-microchip', 'fa-hard-drive', 'fa-memory', 'fa-desktop',
                        'fa-computer-mouse', 'fa-keyboard', 'fa-plug', 'fa-code-branch', 'fa-triangle-exclamation'
                    ],

                    // 模拟仓库数据结构
                    shelves: [
                        {
                            id: 'S01', code: 'A-01货架', type: '重型货架',
                            bins: [
                                {
                                    id: 101, code: 'A-01-1-1', material: '高性能CPU i9', matId: 'M-8821', qty: 50, unit: '盒', batch: 'B20231011', status: 'normal', icon: 'fa-microchip',
                                    traceability: [
                                        { time: '刚刚', event: '盘点核查完成', detail: '操作人: 张三' },
                                        { time: '2023-10-15 14:30', event: '部分出库 (50个)', detail: '关联单号: OUT-2023001' },
                                        { time: '2023-10-12 09:00', event: '入库上架', detail: '来源: 采购入库' }
                                    ]
                                },
                                {
                                    id: 102, code: 'A-01-1-2', material: '512G 固态硬盘', matId: 'M-3321', qty: 120, unit: '个', batch: 'B20231012', status: 'normal', icon: 'fa-hard-drive',
                                    traceability: [
                                        { time: '2023-10-12 10:00', event: '入库上架', detail: '来源: 生产入库' }
                                    ]
                                },
                                { id: 103, code: 'A-01-2-1', material: null, traceability: [] }, // 空位
                                {
                                    id: 104, code: 'A-01-2-2', material: 'DDR5 内存条', matId: 'M-1102', qty: 10, unit: '条', batch: 'B20230101', status: 'warning', icon: 'fa-memory',
                                    traceability: [
                                        { time: '2023-10-20 09:00', event: '库存预警触发', detail: '原因: 库存量低于安全阈值' },
                                        { time: '2023-01-01 08:30', event: '入库上架', detail: '来源: 采购入库' }
                                    ]
                                }
                            ]
                        },
                        {
                            id: 'S02', code: 'A-02货架', type: '中型货架',
                            bins: [
                                {
                                    id: 201, code: 'A-02-1-1', material: '高清显示屏', matId: 'M-9901', qty: 30, unit: '台', batch: 'B20230909', status: 'normal', icon: 'fa-desktop',
                                    traceability: [
                                        { time: '2023-09-09 11:00', event: '入库上架', detail: '来源: 供应商直发' }
                                    ]
                                },
                                { id: 202, code: 'A-02-1-2', material: null, traceability: [] },
                                {
                                    id: 203, code: 'A-02-2-1', material: '无线鼠标', matId: 'M-7721', qty: 200, unit: '个', batch: 'B20231005', status: 'normal', icon: 'fa-computer-mouse',
                                    traceability: [
                                        { time: '2023-10-05 15:20', event: '入库上架', detail: '来源: 采购入库' }
                                    ]
                                },
                                {
                                    id: 204, code: 'A-02-2-2', material: '机械键盘', matId: 'M-7722', qty: 5, unit: '把', batch: 'B20221230', status: 'warning', icon: 'fa-keyboard',
                                    traceability: [
                                        { time: '2023-10-25 08:00', event: '呆滞品预警', detail: '原因: 超过180天无异动' },
                                        { time: '2022-12-30 09:00', event: '入库上架', detail: '来源: 采购入库' }
                                    ]
                                }
                            ]
                        },
                        {
                            id: 'S03', code: 'A-03货架', type: '轻型货架',
                            bins: [
                                {
                                    id: 301, code: 'A-03-1-1', material: '电源适配器', matId: 'M-5511', qty: 80, unit: '个', batch: 'B20231001', status: 'normal', icon: 'fa-plug',
                                    traceability: [
                                        { time: '2023-10-01 13:00', event: '入库上架', detail: '来源: 采购入库' }
                                    ]
                                },
                                {
                                    id: 302, code: 'A-03-1-2', material: 'HDMI高清线', matId: 'M-5522', qty: 500, unit: '条', batch: 'B20231001', status: 'normal', icon: 'fa-code-branch',
                                    traceability: [
                                        { time: '2023-10-01 13:15', event: '入库上架', detail: '来源: 采购入库' }
                                    ]
                                },
                                { id: 303, code: 'A-03-2-1', material: null, traceability: [] },
                                { id: 304, code: 'A-03-2-2', material: null, traceability: [] }
                            ]
                        },
                        {
                            id: 'S04', code: 'A-04货架', type: '返修区',
                            bins: [
                                {
                                    id: 401, code: 'A-04-1-1', material: '待检主板', matId: 'M-0011', qty: 3, unit: '块', batch: 'R-202310', status: 'warning', icon: 'fa-triangle-exclamation',
                                    traceability: [
                                        { time: '2023-10-24 16:00', event: '登记入库', detail: '来源: 产线退回' },
                                        { time: '2023-10-24 15:30', event: '质检不合格', detail: '原因: 开机无显示' }
                                    ]
                                },
                                { id: 402, code: 'A-04-1-2', material: null, traceability: [] },
                                { id: 403, code: 'A-04-2-1', material: null, traceability: [] },
                                { id: 404, code: 'A-04-2-2', material: null, traceability: [] }
                            ]
                        }
                    ]
                }
            },
            computed: {
                totalBins() {
                    let count = 0;
                    this.shelves.forEach(s => count += s.bins.length);
                    return count;
                }
            },
            methods: {
                updateTime() {
                    const now = new Date();
                    this.currentTime = now.getFullYear() + '-' +
                        String(now.getMonth() + 1).padStart(2, '0') + '-' +
                        String(now.getDate()).padStart(2, '0') + ' ' +
                        String(now.getHours()).padStart(2, '0') + ':' +
                        String(now.getMinutes()).padStart(2, '0') + ':' +
                        String(now.getSeconds()).padStart(2, '0');
                },
                selectBin(bin) {
                    // Handle Move Logic
                    if (this.isMoveMode) {
                        this.handleMoveSelection(bin);
                        return;
                    }

                    this.currentBin = bin;
                    this.detailLoading = true;
                    console.log('Querying details for bin', bin.code);

                    // 模拟异步数据请求 (XN-002)
                    setTimeout(() => {
                        this.detailLoading = false;
                    }, 600);
                },

                // Inbound Logic
                initiateInbound() {
                    // Reset form
                    this.inboundForm = {
                        material: '',
                        matId: 'M-' + Math.floor(Math.random() * 10000), // Random ID suggestion
                        qty: 100,
                        unit: '个',
                        batch: 'B' + new Date().toISOString().slice(0, 10).replace(/-/g, ''),
                        icon: 'fa-box'
                    };
                    this.showInboundModal = true;
                },
                confirmInbound() {
                    if (!this.inboundForm.material || !this.inboundForm.qty) {
                        this.showToast('请填写完整物资信息');
                        return;
                    }

                    if (!this.currentBin) return;

                    // Update Bin Data
                    this.currentBin.material = this.inboundForm.material;
                    this.currentBin.matId = this.inboundForm.matId;
                    this.currentBin.qty = this.inboundForm.qty;
                    this.currentBin.unit = this.inboundForm.unit;
                    this.currentBin.batch = this.inboundForm.batch;
                    this.currentBin.status = 'normal';
                    this.currentBin.icon = this.inboundForm.icon;

                    // Add Trace
                    this.currentBin.traceability = [];
                    this.currentBin.traceability.unshift({
                        time: new Date().toLocaleString(),
                        event: '入库分配',
                        detail: `初始入库: ${this.inboundForm.qty} ${this.inboundForm.unit}, 来源: 手动分配`
                    });

                    this.showToast(`入库成功: ${this.inboundForm.material} 已分配至 ${this.currentBin.code}`);
                    this.showInboundModal = false;

                    // Force refresh view? Vue reactivity handles it.
                },

                // Outbound Logic
                initiateOutbound() {
                    this.outboundQty = 1;
                    this.showOutboundModal = true;
                },
                confirmOutbound() {
                    if (!this.currentBin || !this.outboundQty) return;

                    const qty = this.outboundQty;
                    if (qty > this.currentBin.qty) {
                        this.showToast('出库数量不能大于库存数量');
                        return;
                    }

                    // Perform Outbound
                    this.currentBin.qty -= qty;
                    this.currentBin.traceability.unshift({
                        time: new Date().toLocaleString(),
                        event: '出库下架',
                        detail: `数量: ${qty} ${this.currentBin.unit}, 操作人: 当前用户`
                    });

                    // If qty becomes 0, clear material but keep trace? Usually clear bin or mark as empty.
                    // Let's clear bin content if qty is 0 for visual feedback, or just keep it empty with history?
                    // "Virtual Shelf" usually implies empty bin = no material.
                    if (this.currentBin.qty <= 0) {
                        // Keep traceability but clear material data for "history"? 
                        // Actually, if it's empty, we usually clear the bin data structure in this simple model.
                        // But to show history, maybe we need a separate history log or just clear it.
                        // Let's clear material properties but keep the object structure clean.
                        // Wait, if I clear material, the UI shows "Empty".
                        this.showToast(`出库成功，货位 ${this.currentBin.code} 已清空`);

                        // Deep clone trace to save somewhere? For now just clear bin properties
                        this.currentBin.material = null;
                        this.currentBin.matId = null;
                        this.currentBin.qty = 0;
                        this.currentBin.batch = null;
                        this.currentBin.status = null;
                        this.currentBin.icon = null;
                        this.currentBin.traceability = []; // Clear trace for new item? Or keep? Usually clear.

                        this.currentBin = null; // Close drawer
                    } else {
                        this.showToast(`出库成功，剩余库存: ${this.currentBin.qty}`);
                    }

                    this.showOutboundModal = false;
                },

                // Move Logic
                initiateMove() {
                    this.isMoveMode = true;
                    this.moveSourceBin = this.currentBin;
                    this.currentBin = null; // Close drawer
                    this.showToast('请点击选择目标货位 (空闲货位)');
                },
                cancelMove() {
                    this.isMoveMode = false;
                    this.moveSourceBin = null;
                    this.showToast('移库操作已取消');
                },
                handleMoveSelection(targetBin) {
                    if (targetBin.id === this.moveSourceBin.id) {
                        this.cancelMove();
                        return;
                    }

                    if (targetBin.material) {
                        this.showToast('目标货位非空，请选择空闲货位');
                        return;
                    }

                    // Perform Move
                    // Copy data
                    targetBin.material = this.moveSourceBin.material;
                    targetBin.matId = this.moveSourceBin.matId;
                    targetBin.qty = this.moveSourceBin.qty;
                    targetBin.unit = this.moveSourceBin.unit;
                    targetBin.batch = this.moveSourceBin.batch;
                    targetBin.status = this.moveSourceBin.status;
                    targetBin.icon = this.moveSourceBin.icon;
                    targetBin.traceability = [...this.moveSourceBin.traceability]; // Clone array

                    // Add Trace
                    const moveTime = new Date().toLocaleString();
                    targetBin.traceability.unshift({
                        time: moveTime,
                        event: '移库转入',
                        detail: `来源货位: ${this.moveSourceBin.code}`
                    });

                    // Clear Source
                    this.moveSourceBin.material = null;
                    this.moveSourceBin.matId = null;
                    this.moveSourceBin.qty = 0;
                    this.moveSourceBin.batch = null;
                    this.moveSourceBin.status = null;
                    this.moveSourceBin.icon = null;
                    this.moveSourceBin.traceability = [];

                    this.showToast(`移库成功: ${this.moveSourceBin.code} -> ${targetBin.code}`);

                    this.isMoveMode = false;
                    this.moveSourceBin = null;
                },

                getBinColorClass(bin, shelf) {
                    if (!bin.material) return 'bg-gray-700/30 border-gray-700 text-slate-600 hover:border-gray-500';
                    if (bin.status === 'warning') return 'bg-red-500/10 border-red-500/30 text-red-400 hover:border-red-500/50 shadow-[0_0_10px_rgba(239,68,68,0.1)]';

                    // Dark mode colors for shelf types
                    if (shelf && shelf.type) {
                        if (shelf.type === '重型货架') return 'bg-blue-600/10 border-blue-500/30 text-blue-300 hover:border-blue-500/50 hover:bg-blue-600/20';
                        if (shelf.type === '中型货架') return 'bg-emerald-600/10 border-emerald-500/30 text-emerald-300 hover:border-emerald-500/50 hover:bg-emerald-600/20';
                        if (shelf.type === '轻型货架') return 'bg-amber-600/10 border-amber-500/30 text-amber-300 hover:border-amber-500/50 hover:bg-amber-600/20';
                        if (shelf.type === '返修区') return 'bg-purple-600/10 border-purple-500/30 text-purple-300 hover:border-purple-500/50 hover:bg-purple-600/20';
                    }

                    return 'bg-emerald-600/10 border-emerald-500/30 text-emerald-300 hover:border-emerald-500/50';
                },
                isMatch(bin) {
                    if (!this.searchKeyword || !bin.material) return false;
                    const kw = this.searchKeyword.toLowerCase();
                    return bin.material.toLowerCase().includes(kw) ||
                        bin.code.toLowerCase().includes(kw) ||
                        bin.matId.toLowerCase().includes(kw);
                },
                handleSearch() {
                    // XN-003: 搜索反馈
                    if (this.searchKeyword.length > 0) {
                        let count = 0;
                        const kw = this.searchKeyword.toLowerCase();
                        this.shelves.forEach(shelf => {
                            shelf.bins.forEach(bin => {
                                if (bin.material && (
                                    bin.material.toLowerCase().includes(kw) ||
                                    bin.code.toLowerCase().includes(kw) ||
                                    bin.matId.toLowerCase().includes(kw)
                                )) {
                                    count++;
                                }
                            });
                        });

                        if (count === 0) {
                            this.showToast('未找到匹配物资');
                        } else {
                            // 可选：如果找到太多，就不提示，或者提示数量
                            // this.showToast(`找到 ${count} 个匹配项`);
                        }
                    }
                },
                showToast(msg) {
                    this.toastMessage = msg;
                    setTimeout(() => {
                        this.toastMessage = null;
                    }, 2000);
                }
            },
            mounted() {
                this.updateTime();

                // 模拟初始化加载 (XN-001)
                setTimeout(() => {
                    this.isLoading = false;
                }, 1500);

                setInterval(() => {
                    this.updateTime();
                    this.lastUpdateTime = new Date().toLocaleTimeString();
                }, 1000);
            }
        }).mount('#app')
    </script>
</body>

</html>